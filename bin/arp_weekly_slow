source ~/.psql-shortcuts
shopt -s expand_aliases
psqlarp_su $* -c "
select * from (select trim(database) as DB, count(query) as n_qry, max(substring (qrytext,1,80)) as qrytext,
  min(run_minutes) as "min" , max(run_minutes) as "max", avg(run_minutes) as "avg", sum(run_minutes) as total,
  max(query) as max_query_id,
max(starttime)::date as last_run, aborted, event
from (
  select userid, label, stl_query.query, trim(database) as database,
  substring(trim(querytxt),1,58) as qrytext, md5(substring(trim(querytxt),1,58)) as qry_md5,
  starttime, endtime, datediff(minutes,starttime,endtime)::numeric(12,2) as run_minutes,
  aborted,
  decode(alrt.event,'Very selective query filter','Filter','Scanned a large number of deleted rows',
    'Deleted','Nested Loop Join in the query plan','Nested Loop',
    'Distributed a large number of rows across the network','Distributed',
    'Broadcasted a large number of rows across the network','Broadcast',
    'Missing query planner statistics','Stats',alrt.event) as event
from stl_query
left outer join ( select query, trim(split_part(event,':',1)) as event from STL_ALERT_EVENT_LOG
  where event_time >=  dateadd(day, -7, current_Date)
  group by query, trim(split_part(event,':',1))
)
as alrt
  on alrt.query = stl_query.query
where userid <> 1

and starttime >=  dateadd(day, -7, current_Date)
)
group by database, label, qry_md5, aborted, event
order by total desc limit 50) where total > 20000 / 60 order by qrytext, event, total;
"
